<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote View Control - Server</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .code-display {
            font-size: 3rem;
            font-weight: bold;
            letter-spacing: 0.5rem;
            color: #667eea;
            font-family: 'Courier New', monospace;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-waiting {
            background-color: #ffc107;
            animation: pulse 1.5s infinite;
        }
        .status-connected {
            background-color: #28a745;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <i class="bi bi-display fs-1 text-primary"></i>
                            <h2 class="mt-2">Server Control Panel</h2>
                        </div>

                    <!-- Waiting for client -->
                    <div id="waitingState">
                        <div class="text-center mb-4">
                            <p class="text-muted mb-2">Controlling client:</p>
                            <div class="code-display p-3 bg-light rounded" id="clientNameDisplay"></div>
                        </div>
                        
                        <div class="alert alert-info" id="waitingAlert">
                            <span class="status-indicator status-waiting"></span>
                            Waiting for client to connect...
                        </div>
                        
                        <div class="text-center">
                            <a href="/admin" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Back to Admin Panel
                            </a>
                        </div>
                    </div>

                    <!-- Connected State -->
                    <div id="connectedState" class="d-none">
                            <div class="alert alert-success mb-4">
                                <span class="status-indicator status-connected"></span>
                                <strong>Client Connected!</strong>
                            </div>

                            <!-- URL Section -->
                            <div class="mb-4">
                                <label for="urlInput" class="form-label fw-bold">
                                    <i class="bi bi-link-45deg me-1"></i>Send URL:
                                </label>
                                <div class="input-group">
                                    <input type="url" class="form-control" id="urlInput" 
                                           placeholder="https://example.com" 
                                           value="https://www.example.com">
                                    <button class="btn btn-primary" type="button" id="btnSendUrl">
                                        <i class="bi bi-send me-1"></i>Send
                                    </button>
                                </div>
                            </div>

                            <!-- Quick Action Launcher -->
                            <div class="mb-4">
                                <label for="actionSelect" class="form-label fw-bold">
                                    <i class="bi bi-play-circle me-1"></i>Launch Saved Action:
                                </label>
                                <div class="input-group mb-2">
                                    <select class="form-select" id="actionSelect">
                                        <option value="">Select an action...</option>
                                    </select>
                                    <button class="btn btn-success" type="button" id="btnLaunchAction" disabled>
                                        <i class="bi bi-rocket-takeoff me-1"></i>Launch
                                    </button>
                                    <button class="btn btn-outline-primary" type="button" id="btnNewAction" title="Create new action">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" id="btnEditAction" disabled title="Edit selected action">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" type="button" id="btnDeleteAction" disabled title="Delete selected action">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Sends the action's URL and activates the action on the client</small>
                            </div>

                            <!-- Script Section -->
                            <div class="mb-3">
                                <label for="scriptInput" class="form-label fw-bold">
                                    <i class="bi bi-code-slash me-1"></i>Execute JavaScript:
                                </label>
                                <textarea class="form-control font-monospace" id="scriptInput" rows="3" 
                                          placeholder="document.body.style.zoom = '150%'"></textarea>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="form-text">Run custom JavaScript on the client display.</div>
                                    <button class="btn btn-warning btn-sm" type="button" id="btnExecuteScript">
                                        <i class="bi bi-play-fill me-1"></i>Execute
                                    </button>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-lightning me-1"></i>Quick Actions:
                                </label>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-outline-secondary btn-sm quick-script" 
                                            data-script="document.body.style.zoom = '150%'">Zoom 150%</button>
                                    <button class="btn btn-outline-secondary btn-sm quick-script" 
                                            data-script="document.body.style.zoom = '100%'">Zoom 100%</button>
                                    <button class="btn btn-outline-secondary btn-sm quick-script" 
                                            data-script="document.documentElement.requestFullscreen()">Fullscreen</button>
                                    <button class="btn btn-outline-secondary btn-sm quick-script" 
                                            data-script="window.scrollTo(0, 0)">Scroll Top</button>
                                    <button class="btn btn-outline-secondary btn-sm quick-script" 
                                            data-script="window.scrollTo(0, document.body.scrollHeight)">Scroll Bottom</button>
                                    <button class="btn btn-outline-secondary btn-sm" id="btnSimulateClick">
                                        <i class="bi bi-mouse me-1"></i>Simulate Click</button>
                                    <button class="btn btn-outline-info btn-sm" id="btnViewLogs">
                                        <i class="bi bi-file-text me-1"></i>View Logs <span class="badge bg-secondary" id="logCount">0</span></button>
                                </div>
                            </div>

                            <div id="actionConfirmation" class="alert alert-success d-none">
                                <i class="bi bi-check-circle me-1"></i>
                                <span id="confirmationMessage">Action completed!</span>
                            </div>
                        </div>

                        <!-- Disconnected State -->
                        <div id="disconnectedState" class="d-none">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                Client disconnected. Waiting for reconnection...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logsModalLabel">
                        <i class="bi bi-file-text me-2"></i>Client Logs
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoScrollLogs" checked>
                            <label class="form-check-label" for="autoScrollLogs">
                                Auto-scroll to bottom
                            </label>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" id="btnClearLogs">
                            <i class="bi bi-trash me-1"></i>Clear Logs
                        </button>
                    </div>
                    <div id="logsContainer" class="border rounded p-3 bg-light" style="max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem;">
                        <div class="text-muted text-center">No logs yet...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mouse Click Modal -->
    <div class="modal fade" id="mouseClickModal" tabindex="-1" aria-labelledby="mouseClickModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mouseClickModalLabel">
                        <i class="bi bi-mouse me-2"></i>Simulate Mouse Click
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info" id="dimensionsInfo" style="display: none;">
                        <i class="bi bi-info-circle me-1"></i>
                        Display Size: <strong id="displayWidth">-</strong> x <strong id="displayHeight">-</strong> pixels
                    </div>
                    <div class="mb-3">
                        <label for="clickX" class="form-label">X Coordinate:</label>
                        <input type="number" class="form-control" id="clickX" placeholder="e.g., 100" value="100" min="0">
                    </div>
                    <div class="mb-3">
                        <label for="clickY" class="form-label">Y Coordinate:</label>
                        <input type="number" class="form-control" id="clickY" placeholder="e.g., 100" value="100" min="0">
                    </div>
                    <div class="form-text">
                        <i class="bi bi-info-circle me-1"></i>Coordinates are relative to the display window (top-left is 0,0)
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnSendClick">
                        <i class="bi bi-send me-1"></i>Send Click
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Builder Modal -->
    <div class="modal fade" id="actionBuilderModal" tabindex="-1" aria-labelledby="actionBuilderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="actionBuilderModalLabel">
                        <span id="actionFormTitle"><i class="bi bi-plus-circle me-2"></i>Create New Action</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row justify-content-center">
                        <!-- Action Form -->
                        <div class="col-12">
                                    <form id="actionForm">
                                        <!-- Action Name -->
                                        <div class="mb-3">
                                            <label for="actionName" class="form-label fw-bold">
                                                <i class="bi bi-tag me-1"></i>Action Name
                                            </label>
                                            <input type="text" class="form-control" id="actionName" 
                                                   placeholder="e.g., Click Play Button" required>
                                        </div>

                                        <!-- Target URL -->
                                        <div class="mb-3">
                                            <label for="actionTargetUrl" class="form-label fw-bold">
                                                <i class="bi bi-link-45deg me-1"></i>Target URL
                                            </label>
                                            <input type="url" class="form-control" id="actionTargetUrl" 
                                                   placeholder="https://www..." required>
                                            <small class="text-muted">The URL where this action applies (the page that will be loaded)</small>
                                        </div>

                                        <!-- Description -->
                                        <div class="mb-3">
                                            <label for="actionDescription" class="form-label fw-bold">
                                                <i class="bi bi-text-left me-1"></i>Description (Optional)
                                            </label>
                                            <textarea class="form-control" id="actionDescription" rows="2" 
                                                      placeholder="What does this action do?"></textarea>
                                        </div>

                                        <hr class="my-3">
                                        <h6 class="text-primary mb-3">
                                            <i class="bi bi-flag-fill me-2"></i>Trigger Configuration
                                        </h6>

                                        <!-- Element Type -->
                                        <div class="mb-3">
                                            <label for="elementType" class="form-label fw-bold">
                                                <i class="bi bi-box me-1"></i>Element Type
                                            </label>
                                            <select class="form-select" id="elementType" required>
                                                <option value="div">Div Element</option>
                                                <option value="button">Button Element</option>
                                            </select>
                                        </div>

                                        <!-- Element Selector -->
                                        <div class="mb-3">
                                            <label for="elementSelector" class="form-label fw-bold">
                                                <i class="bi bi-code-square me-1"></i>CSS Selector
                                            </label>
                                            <input type="text" class="form-control" id="elementSelector" 
                                                   placeholder=".play-button, #videoPlayer" required>
                                            <small class="text-muted">CSS selector to identify the element</small>
                                        </div>

                                        <hr class="my-3">
                                        <h6 class="text-success mb-3">
                                            <i class="bi bi-lightning-fill me-2"></i>Action to Execute
                                        </h6>

                                        <!-- Action Type -->
                                        <div class="mb-3">
                                            <label for="actionType" class="form-label fw-bold">
                                                <i class="bi bi-cursor-fill me-1"></i>Action Type
                                            </label>
                                            <select class="form-select" id="actionType" required>
                                                <option value="click">Simulate Mouse Click at Coordinates</option>
                                                <option value="navigate">Navigate to Different URL</option>
                                            </select>
                                            <small class="text-muted">What should happen when the element is detected?</small>
                                        </div>

                                        <!-- Click Coordinates (conditional) -->
                                        <div class="mb-3" id="clickCoordinatesContainer">
                                            <label class="form-label fw-bold">
                                                <i class="bi bi-cursor-fill me-1"></i>Click Coordinates
                                            </label>
                                            <div class="row">
                                                <div class="col-6">
                                                    <label for="actionClickX" class="form-label">X:</label>
                                                    <input type="number" class="form-control" id="actionClickX" 
                                                           placeholder="100" min="0" value="100">
                                                </div>
                                                <div class="col-6">
                                                    <label for="actionClickY" class="form-label">Y:</label>
                                                    <input type="number" class="form-control" id="actionClickY" 
                                                           placeholder="100" min="0" value="100">
                                                </div>
                                            </div>
                                            <small class="text-muted">Pixel coordinates where to click (top-left is 0,0)</small>
                                        </div>

                                        <!-- Navigate URL (conditional) -->
                                        <div class="mb-3" id="navigateUrlContainer" style="display: none;">
                                            <label for="navigateUrl" class="form-label fw-bold">
                                                <i class="bi bi-link-45deg me-1"></i>Navigate To (Destination URL)
                                            </label>
                                            <input type="url" class="form-control" id="navigateUrl" 
                                                   placeholder="https://example.com/next-page">
                                            <small class="text-muted">The URL to navigate to when the element appears</small>
                                        </div>

                                        <!-- Delay -->
                                        <div class="mb-3">
                                            <label for="delaySeconds" class="form-label fw-bold">
                                                <i class="bi bi-clock me-1"></i>Delay Before Execution
                                            </label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="delaySeconds" 
                                                       min="0" max="300" value="0">
                                                <span class="input-group-text">seconds</span>
                                            </div>
                                            <small class="text-muted">0 = immediate</small>
                                        </div>

                                        <!-- Active Status -->
                                        <div class="mb-3 form-check">
                                            <input type="checkbox" class="form-check-input" id="isActive" checked>
                                            <label class="form-check-label fw-bold" for="isActive">
                                                Action is Active
                                            </label>
                                        </div>

                                        <!-- Submit Buttons -->
                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-primary" id="btnSaveAction">
                                                <i class="bi bi-check-circle me-2"></i>
                                                <span id="btnSaveText">Create Action</span>
                                            </button>
                                            <button type="button" class="btn btn-secondary" id="btnCancelEdit" style="display: none;">
                                                <i class="bi bi-x-circle me-2"></i>Cancel Edit
                                            </button>
                                        </div>
                                    </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Action Confirmation Modal -->
    <div class="modal fade" id="deleteActionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this action?</p>
                    <p class="mb-0"><strong id="deleteActionName"></strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmDeleteAction">
                        <i class="bi bi-trash me-1"></i>Delete Action
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        let connection = null;
        let clientName = '';
        
        // Action Builder variables
        let allActions = [];
        let editingActionId = null;
        let actionBuilderModal = null;
        let deleteActionModal = null;
        let actionToDelete = null;

        // Get client name from URL path
        function getClientNameFromUrl() {
            const pathParts = window.location.pathname.split('/').filter(p => p);
            // Path should be /server/<client-name>
            if (pathParts.length >= 2 && pathParts[0] === 'server') {
                return decodeURIComponent(pathParts[1]);
            }
            return null;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            clientName = getClientNameFromUrl();
            
            if (!clientName) {
                window.location.href = '/admin?error=' + encodeURIComponent('No client specified');
                return;
            }

            document.getElementById('clientNameDisplay').textContent = clientName;
            
            await connectToHub();
        });

        document.getElementById('btnSendUrl').addEventListener('click', sendUrl);
        document.getElementById('btnExecuteScript').addEventListener('click', executeScript);
        
        document.getElementById('urlInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendUrl();
        });

        // Quick script buttons
        document.querySelectorAll('.quick-script').forEach(btn => {
            btn.addEventListener('click', async () => {
                const script = btn.dataset.script;
                try {
                    await connection.invoke('ExecuteScriptOnClient', clientName, script);
                    showConfirmation('Script executed!');
                } catch (error) {
                    console.error('Error executing script:', error);
                    alert('Failed to execute script.');
                }
            });
        });

        // Mouse click simulation
        let mouseClickModal = null;
        let displayWidth = null;
        let displayHeight = null;
        
        document.getElementById('btnSimulateClick').addEventListener('click', () => {
            if (!mouseClickModal) {
                mouseClickModal = new bootstrap.Modal(document.getElementById('mouseClickModal'));
            }
            mouseClickModal.show();
        });

        // New Action button
        document.getElementById('btnNewAction').addEventListener('click', () => {
            if (!actionBuilderModal) {
                actionBuilderModal = new bootstrap.Modal(document.getElementById('actionBuilderModal'));
            }
            resetActionForm();
            actionBuilderModal.show();
        });

        // Edit Action button
        document.getElementById('btnEditAction').addEventListener('click', () => {
            const select = document.getElementById('actionSelect');
            const actionId = select.value;
            if (!actionId) return;
            
            if (!actionBuilderModal) {
                actionBuilderModal = new bootstrap.Modal(document.getElementById('actionBuilderModal'));
            }
            editAction(actionId);
            actionBuilderModal.show();
        });

        // Delete Action button
        document.getElementById('btnDeleteAction').addEventListener('click', () => {
            const select = document.getElementById('actionSelect');
            const actionId = select.value;
            if (!actionId) return;
            
            const action = allActions.find(a => a.id === actionId);
            if (action) {
                confirmDeleteAction(actionId, action.name);
            }
        });

        // Action Launcher and dropdown change handler
        document.getElementById('actionSelect').addEventListener('change', (e) => {
            const launchBtn = document.getElementById('btnLaunchAction');
            const editBtn = document.getElementById('btnEditAction');
            const deleteBtn = document.getElementById('btnDeleteAction');
            const hasSelection = !!e.target.value;
            
            launchBtn.disabled = !hasSelection;
            editBtn.disabled = !hasSelection;
            deleteBtn.disabled = !hasSelection;
        });

        document.getElementById('btnLaunchAction').addEventListener('click', async () => {
            const select = document.getElementById('actionSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) return;
            
            const actionUrl = selectedOption.dataset.url;
            const actionName = selectedOption.textContent;
            
            try {
                // Send the URL to the client
                await connection.invoke('SendUrlToClient', clientName, actionUrl);
                showConfirmation(`Launched: ${actionName}`);
                
                // Optionally reset the select
                select.selectedIndex = 0;
                document.getElementById('btnLaunchAction').disabled = true;
            } catch (error) {
                console.error('Error launching action:', error);
                alert('Failed to launch action');
            }
        });

        // Action Builder form handlers
        document.getElementById('actionType').addEventListener('change', (e) => {
            const urlContainer = document.getElementById('navigateUrlContainer');
            const urlInput = document.getElementById('navigateUrl');
            const coordContainer = document.getElementById('clickCoordinatesContainer');
            const clickX = document.getElementById('actionClickX');
            const clickY = document.getElementById('actionClickY');
            
            if (e.target.value === 'navigate') {
                urlContainer.style.display = 'block';
                urlInput.required = true;
                coordContainer.style.display = 'none';
                clickX.required = false;
                clickY.required = false;
            } else {
                urlContainer.style.display = 'none';
                urlInput.required = false;
                coordContainer.style.display = 'block';
                clickX.required = true;
                clickY.required = true;
            }
        });

        document.getElementById('actionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveAction();
        });

        document.getElementById('btnCancelEdit').addEventListener('click', () => {
            resetActionForm();
            if (actionBuilderModal) {
                actionBuilderModal.hide();
            }
        });
        
        // Reset form when modal is closed
        document.getElementById('actionBuilderModal').addEventListener('hidden.bs.modal', () => {
            resetActionForm();
        });

        document.getElementById('btnConfirmDeleteAction').addEventListener('click', async () => {
            if (actionToDelete) {
                await deleteAction(actionToDelete);
                deleteActionModal.hide();
                actionToDelete = null;
            }
        });

        async function loadActions() {
            try {
                const response = await fetch(`/api/actions/${clientName}`);
                if (response.ok) {
                    allActions = await response.json();
                    displayActions();
                    populateActionDropdown();
                }
            } catch (error) {
                console.error('Error loading actions:', error);
            }
        }

        function populateActionDropdown() {
            const select = document.getElementById('actionSelect');
            const launchBtn = document.getElementById('btnLaunchAction');
            
            // Clear existing options except first
            select.innerHTML = '<option value="">Select an action...</option>';
            
            // Add active actions
            const activeActions = allActions.filter(a => a.isActive);
            activeActions.forEach(action => {
                const option = document.createElement('option');
                option.value = action.id;
                option.textContent = `${action.name} - ${action.targetUrl}`;
                option.dataset.url = action.targetUrl;
                select.appendChild(option);
            });
            
            // Enable/disable launch button
            launchBtn.disabled = activeActions.length === 0;
        }

        function displayActions() {
            // This function is no longer needed for modal display
            // but we keep it for backward compatibility
            // Actions are now managed through the dropdown and action buttons
        }

        async function saveAction() {
            const clickXValue = document.getElementById('actionClickX').value;
            const clickYValue = document.getElementById('actionClickY').value;
            
            console.log('Raw input values - clickX:', clickXValue, 'clickY:', clickYValue);
            
            const actionData = {
                name: document.getElementById('actionName').value,
                targetUrl: document.getElementById('actionTargetUrl').value,
                description: document.getElementById('actionDescription').value,
                isActive: document.getElementById('isActive').checked,
                trigger: {
                    type: 'elementVisible',
                    elementType: document.getElementById('elementType').value,
                    selector: document.getElementById('elementSelector').value
                },
                action: {
                    type: document.getElementById('actionType').value,
                    clickX: document.getElementById('actionType').value === 'click'
                        ? parseInt(clickXValue)
                        : null,
                    clickY: document.getElementById('actionType').value === 'click'
                        ? parseInt(clickYValue)
                        : null,
                    url: document.getElementById('actionType').value === 'navigate' 
                        ? document.getElementById('navigateUrl').value 
                        : null,
                    delaySeconds: parseInt(document.getElementById('delaySeconds').value) || 0
                }
            };
            
            console.log('Sending action data:', JSON.stringify(actionData, null, 2));

            try {
                let response;
                if (editingActionId) {
                    response = await fetch(`/api/actions/${clientName}/${editingActionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(actionData)
                    });
                } else {
                    response = await fetch(`/api/actions/${clientName}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(actionData)
                    });
                }

                if (response.ok) {
                    await loadActions();
                    await notifyClientOfActions();
                    resetActionForm();
                    populateActionDropdown();
                    showConfirmation('Action saved successfully!');
                    
                    // Close the modal
                    if (actionBuilderModal) {
                        actionBuilderModal.hide();
                    }
                } else {
                    alert('Failed to save action');
                }
            } catch (error) {
                console.error('Error saving action:', error);
                alert('Failed to save action');
            }
        }

        function editAction(actionId) {
            const action = allActions.find(a => a.id === actionId);
            if (!action) return;

            console.log('Editing action:', action);
            console.log('ClickX:', action.action.clickX, 'ClickY:', action.action.clickY);

            editingActionId = actionId;

            document.getElementById('actionName').value = action.name;
            document.getElementById('actionTargetUrl').value = action.targetUrl || '';
            document.getElementById('actionDescription').value = action.description || '';
            document.getElementById('elementType').value = action.trigger.elementType;
            document.getElementById('elementSelector').value = action.trigger.selector;
            document.getElementById('actionType').value = action.action.type;
            document.getElementById('delaySeconds').value = action.action.delaySeconds;
            document.getElementById('isActive').checked = action.isActive;
            
            // Set coordinate values explicitly
            const clickXInput = document.getElementById('actionClickX');
            const clickYInput = document.getElementById('actionClickY');
            clickXInput.value = action.action.clickX ?? 100;
            clickYInput.value = action.action.clickY ?? 100;
            
            console.log('Set clickX input to:', clickXInput.value, 'clickY input to:', clickYInput.value);
            
            // Set navigate URL
            document.getElementById('navigateUrl').value = action.action.url || '';
            
            // Trigger change event to show/hide appropriate fields
            document.getElementById('actionType').dispatchEvent(new Event('change'));
            
            console.log('After change event - clickX:', clickXInput.value, 'clickY:', clickYInput.value);

            document.getElementById('actionFormTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Action';
            document.getElementById('btnSaveText').textContent = 'Update Action';
            document.getElementById('btnCancelEdit').style.display = 'block';
        }

        async function toggleAction(actionId, isActive) {
            try {
                const response = await fetch(`/api/actions/${clientName}/${actionId}/toggle`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isActive })
                });

                if (response.ok) {
                    await loadActions();
                    await notifyClientOfActions();
                    populateActionDropdown();
                    showConfirmation(`Action ${isActive ? 'activated' : 'deactivated'}`);
                }
            } catch (error) {
                console.error('Error toggling action:', error);
            }
        }

        function confirmDeleteAction(actionId, actionName) {
            if (!deleteActionModal) {
                deleteActionModal = new bootstrap.Modal(document.getElementById('deleteActionModal'));
            }
            actionToDelete = actionId;
            document.getElementById('deleteActionName').textContent = actionName;
            deleteActionModal.show();
        }

        async function deleteAction(actionId) {
            try {
                const response = await fetch(`/api/actions/${clientName}/${actionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadActions();
                    await notifyClientOfActions();
                    populateActionDropdown();
                    showConfirmation('Action deleted successfully');
                }
            } catch (error) {
                console.error('Error deleting action:', error);
            }
        }

        function resetActionForm() {
            document.getElementById('actionForm').reset();
            document.getElementById('navigateUrlContainer').style.display = 'none';
            document.getElementById('actionFormTitle').innerHTML = '<i class="bi bi-plus-circle me-2"></i>Create New Action';
            document.getElementById('btnSaveText').textContent = 'Create Action';
            document.getElementById('btnCancelEdit').style.display = 'none';
            editingActionId = null;
        }

        async function notifyClientOfActions() {
            if (connection && connection.state === signalR.HubConnectionState.Connected) {
                try {
                    await connection.invoke('SendActionsToClient', clientName);
                    console.log('Notified client of action changes');
                } catch (error) {
                    console.error('Error notifying client:', error);
                }
            }
        }

        document.getElementById('btnSendClick').addEventListener('click', async () => {
            const x = parseInt(document.getElementById('clickX').value);
            const y = parseInt(document.getElementById('clickY').value);
            
            if (isNaN(x) || isNaN(y) || x < 0 || y < 0) {
                alert('Please enter valid coordinates (positive numbers)');
                return;
            }

            // Validate against display dimensions if available
            if (displayWidth !== null && displayHeight !== null) {
                if (x >= displayWidth || y >= displayHeight) {
                    alert(`Coordinates out of bounds!\nMax X: ${displayWidth - 1}, Max Y: ${displayHeight - 1}`);
                    return;
                }
            }

            try {
                await connection.invoke('SimulateMouseClick', clientName, x, y);
                mouseClickModal.hide();
                showConfirmation(`Mouse click sent at (${x}, ${y})`);
            } catch (error) {
                console.error('Error sending mouse click:', error);
                alert('Failed to send mouse click.');
            }
        });

        // Allow Enter key to submit in modal
        document.getElementById('mouseClickModal').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('btnSendClick').click();
            }
        });

        // Logs functionality
        let logsModal = null;
        let logMessages = [];
        
        document.getElementById('btnViewLogs').addEventListener('click', () => {
            if (!logsModal) {
                logsModal = new bootstrap.Modal(document.getElementById('logsModal'));
            }
            logsModal.show();
        });

        document.getElementById('btnClearLogs').addEventListener('click', () => {
            logMessages = [];
            document.getElementById('logsContainer').innerHTML = '<div class="text-muted text-center">No logs yet...</div>';
            document.getElementById('logCount').textContent = '0';
        });

        function addLogMessage(level, message, timestamp) {
            const logEntry = { level, message, timestamp: new Date(timestamp) };
            logMessages.push(logEntry);
            
            // Update log count badge
            document.getElementById('logCount').textContent = logMessages.length;
            
            // Format and add to container
            const container = document.getElementById('logsContainer');
            
            // Remove "no logs" message if this is the first log
            if (logMessages.length === 1) {
                container.innerHTML = '';
            }
            
            const logDiv = document.createElement('div');
            logDiv.className = 'mb-1';
            
            const levelColors = {
                'log': 'text-secondary',
                'info': 'text-info',
                'warn': 'text-warning',
                'error': 'text-danger'
            };
            
            const time = logEntry.timestamp.toLocaleTimeString();
            logDiv.innerHTML = `<span class="text-muted">[${time}]</span> <span class="${levelColors[level] || 'text-secondary'}">[${level.toUpperCase()}]</span> ${escapeHtml(message)}`;
            
            container.appendChild(logDiv);
            
            // Auto-scroll if enabled
            if (document.getElementById('autoScrollLogs').checked) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showConfirmation(message) {
            const confirmation = document.getElementById('actionConfirmation');
            document.getElementById('confirmationMessage').textContent = message;
            confirmation.classList.remove('d-none');
            setTimeout(() => confirmation.classList.add('d-none'), 3000);
        }

        async function sendUrl() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) {
                alert('Please enter a URL');
                return;
            }

            try {
                await connection.invoke('SendUrlToClient', clientName, url);
                showConfirmation('URL sent successfully!');
            } catch (error) {
                console.error('Error sending URL:', error);
                alert('Failed to send URL. Please try again.');
            }
        }

        async function executeScript() {
            const script = document.getElementById('scriptInput').value.trim();
            if (!script) {
                alert('Please enter a script');
                return;
            }

            try {
                await connection.invoke('ExecuteScriptOnClient', clientName, script);
                showConfirmation('Script executed!');
            } catch (error) {
                console.error('Error executing script:', error);
                alert('Failed to execute script. Please try again.');
            }
        }

        async function connectToHub() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl('/hub/remoteview', {
                    transport: signalR.HttpTransportType.WebSockets | signalR.HttpTransportType.ServerSentEvents | signalR.HttpTransportType.LongPolling,
                    skipNegotiation: false,
                    timeout: 60000
                })
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.on('ClientConnected', () => {
                document.getElementById('waitingAlert').classList.add('d-none');
                document.getElementById('waitingState').classList.add('d-none');
                document.getElementById('connectedState').classList.remove('d-none');
                document.getElementById('disconnectedState').classList.add('d-none');
                
                // Load actions to populate dropdown
                loadActions();
            });

            connection.on('ClientDisconnected', () => {
                document.getElementById('connectedState').classList.add('d-none');
                document.getElementById('disconnectedState').classList.remove('d-none');
            });

            connection.on('ReceiveLogMessage', (level, message, timestamp) => {
                addLogMessage(level, message, timestamp);
            });

            connection.on('ReceiveDisplayDimensions', (width, height) => {
                displayWidth = width;
                displayHeight = height;
                
                // Update modal display
                document.getElementById('displayWidth').textContent = width;
                document.getElementById('displayHeight').textContent = height;
                document.getElementById('dimensionsInfo').style.display = 'block';
                
                // Update input max attributes
                document.getElementById('clickX').setAttribute('max', width - 1);
                document.getElementById('clickY').setAttribute('max', height - 1);
                
                console.log(`Display dimensions received: ${width}x${height}`);
            });

            connection.on('ActionWasTriggered', (actionId, timestamp) => {
                console.log('Action triggered:', actionId, timestamp);
                // Reload actions to show updated lastTriggered time
                if (actionBuilderModal && actionBuilderModal._isShown) {
                    loadActions();
                }
            });

            connection.on('ResetServer', () => {
                console.log('Reset signal received - redirecting to admin');
                window.location.href = '/admin';
            });

            try {
                console.log('Starting SignalR connection...');
                await connection.start();
                console.log('SignalR connection started successfully');
                const success = await connection.invoke('ServerJoinSession', clientName);
                console.log('ServerJoinSession result:', success);
                if (!success) {
                    window.location.href = '/admin?error=' + encodeURIComponent('Client does not exist or is not connected');
                }
            } catch (error) {
                console.error('Error connecting to hub:', error);
                console.error('Error details:', JSON.stringify(error, Object.getOwnPropertyNames(error)));
                alert('Failed to connect: ' + error.message + '\n\nCheck browser console for details.');
            }
        }
    </script>
</body>
</html>
