<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote View Control - Server</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/server.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <i class="bi bi-display fs-1 text-primary"></i>
                            <h2 class="mt-2">Server Control Panel</h2>
                        </div>

                    <!-- Waiting for client -->
                    <div id="waitingState">
                        <div class="text-center mb-4">
                            <p class="text-muted mb-2">Controlling client:</p>
                            <div class="code-display p-3 bg-light rounded" id="clientNameDisplay"></div>
                        </div>
                        
                        <div class="alert alert-info" id="waitingAlert">
                            <span class="status-indicator status-waiting"></span>
                            Waiting for client to connect...
                        </div>
                        
                        <div class="text-center">
                            <a href="/admin" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Back to Admin Panel
                            </a>
                        </div>
                    </div>

                    <!-- Connected State -->
                    <div id="connectedState" class="d-none">
                            <div class="alert alert-success mb-4">
                                <span class="status-indicator status-connected"></span>
                                <strong>Client Connected!</strong>
                            </div>

                            <!-- URL Section -->
                            <div class="mb-4">
                                <label for="urlInput" class="form-label fw-bold">
                                    <i class="bi bi-link-45deg me-1"></i>Send URL:
                                </label>
                                <div class="input-group">
                                    <input type="url" class="form-control" id="urlInput" 
                                           placeholder="https://example.com" 
                                           value="https://www.example.com">
                                    <button class="btn btn-primary" type="button" id="btnSendUrl">
                                        <i class="bi bi-send me-1"></i>Send
                                    </button>
                                </div>
                            </div>

                            <!-- Quick Action Launcher -->
                            <div class="mb-4">
                                <label for="actionSelect" class="form-label fw-bold">
                                    <i class="bi bi-play-circle me-1"></i>Launch Saved Action:
                                </label>
                                <div class="input-group mb-2">
                                    <select class="form-select" id="actionSelect">
                                        <option value="">Select an action...</option>
                                    </select>
                                    <button class="btn btn-success" type="button" id="btnLaunchAction" disabled>
                                        <i class="bi bi-rocket-takeoff me-1"></i>Launch
                                    </button>
                                    <button class="btn btn-outline-primary" type="button" id="btnNewAction" title="Create new action">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-primary" type="button" id="btnImportAction" title="Import action from JSON file">
                                        <i class="bi bi-upload"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" id="btnEditAction" disabled title="Edit selected action">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-info" type="button" id="btnCloneAction" disabled title="Clone selected action">
                                        <i class="bi bi-files"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" type="button" id="btnDeleteAction" disabled title="Delete selected action">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Sends the action's URL and activates the action on the client</small>
                            </div>

                            <!-- Script Section -->
                            <div class="mb-3">
                                <label for="scriptInput" class="form-label fw-bold">
                                    <i class="bi bi-code-slash me-1"></i>Execute JavaScript:
                                </label>
                                <textarea class="form-control font-monospace" id="scriptInput" rows="3" 
                                          placeholder="document.body.style.zoom = '150%'"></textarea>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="form-text">Run custom JavaScript on the client display.</div>
                                    <button class="btn btn-warning btn-sm" type="button" id="btnExecuteScript">
                                        <i class="bi bi-play-fill me-1"></i>Execute
                                    </button>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-lightning me-1"></i>Quick Actions:
                                </label>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-outline-secondary btn-sm quick-script" 
                                            data-script="document.body.style.zoom = '150%'">Zoom 150%</button>
                                    <button class="btn btn-outline-secondary btn-sm quick-script" 
                                            data-script="document.body.style.zoom = '100%'">Zoom 100%</button>
                                    <button class="btn btn-outline-secondary btn-sm quick-script" 
                                            data-script="document.documentElement.requestFullscreen()">Fullscreen</button>
                                    <button class="btn btn-outline-secondary btn-sm quick-script" 
                                            data-script="window.scrollTo(0, 0)">Scroll Top</button>
                                    <button class="btn btn-outline-secondary btn-sm quick-script" 
                                            data-script="window.scrollTo(0, document.body.scrollHeight)">Scroll Bottom</button>
                                    <button class="btn btn-outline-secondary btn-sm" id="btnSimulateClick">
                                        <i class="bi bi-mouse me-1"></i>Simulate Click</button>
                                    <button class="btn btn-outline-info btn-sm" id="btnViewLogs">
                                        <i class="bi bi-file-text me-1"></i>View Logs <span class="badge bg-secondary" id="logCount">0</span></button>
                                </div>
                            </div>

                            <div id="actionConfirmation" class="alert alert-success d-none">
                                <i class="bi bi-check-circle me-1"></i>
                                <span id="confirmationMessage">Action completed!</span>
                            </div>
                        </div>

                        <!-- Disconnected State -->
                        <div id="disconnectedState" class="d-none">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                Client disconnected. Waiting for reconnection...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logsModalLabel">
                        <i class="bi bi-file-text me-2"></i>Client Logs
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoScrollLogs" checked>
                            <label class="form-check-label" for="autoScrollLogs">
                                Auto-scroll to bottom
                            </label>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" id="btnClearLogs">
                            <i class="bi bi-trash me-1"></i>Clear Logs
                        </button>
                    </div>
                    <div id="logsContainer" class="border rounded p-3 bg-light" style="max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem;">
                        <div class="text-muted text-center">No logs yet...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mouse Click Modal -->
    <div class="modal fade" id="mouseClickModal" tabindex="-1" aria-labelledby="mouseClickModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mouseClickModalLabel">
                        <i class="bi bi-mouse me-2"></i>Simulate Mouse Click
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info" id="dimensionsInfo" style="display: none;">
                        <i class="bi bi-info-circle me-1"></i>
                        Display Size: <strong id="displayWidth">-</strong> x <strong id="displayHeight">-</strong> pixels
                    </div>
                    <div class="mb-3">
                        <label for="clickX" class="form-label">X Coordinate:</label>
                        <input type="number" class="form-control" id="clickX" placeholder="e.g., 100" value="100" min="0">
                    </div>
                    <div class="mb-3">
                        <label for="clickY" class="form-label">Y Coordinate:</label>
                        <input type="number" class="form-control" id="clickY" placeholder="e.g., 100" value="100" min="0">
                    </div>
                    <div class="form-text">
                        <i class="bi bi-info-circle me-1"></i>Coordinates are relative to the display window (top-left is 0,0)
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnSendClick">
                        <i class="bi bi-send me-1"></i>Send Click
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Builder Modal -->
    <div class="modal fade" id="actionBuilderModal" tabindex="-1" aria-labelledby="actionBuilderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="actionBuilderModalLabel">
                        <span id="actionFormTitle"><i class="bi bi-plus-circle me-2"></i>Create New Action</span>
                        <small class="ms-2" id="stepCounter" style="display: none;"></small>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-header bg-primary text-white pt-0">
                    <ul class="nav nav-tabs nav-tabs-custom" id="actionBuilderTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-tab-pane" type="button" role="tab">
                                <i class="bi bi-card-list me-1"></i>Form
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="json-tab" data-bs-toggle="tab" data-bs-target="#json-tab-pane" type="button" role="tab">
                                <i class="bi bi-code-square me-1"></i>JSON
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="modal-body">
                    <div class="tab-content" id="actionBuilderTabContent">
                        <!-- Form Tab -->
                        <div class="tab-pane fade show active" id="form-tab-pane" role="tabpanel">
                            <div class="row justify-content-center">
                                <!-- Action Form -->
                                <div class="col-12">
                                    <form id="actionForm">
                                        <!-- Action Name -->
                                        <div class="mb-3">
                                            <label for="actionName" class="form-label fw-bold">
                                                <i class="bi bi-tag me-1"></i>Action Name
                                            </label>
                                            <input type="text" class="form-control" id="actionName" 
                                                   placeholder="e.g., Click Play Button" required>
                                        </div>

                                        <!-- Target URL -->
                                        <div class="mb-3">
                                            <label for="actionTargetUrl" class="form-label fw-bold">
                                                <i class="bi bi-link-45deg me-1"></i>Target URL
                                            </label>
                                            <input type="url" class="form-control" id="actionTargetUrl" 
                                                   placeholder="https://www..." required>
                                            <small class="text-muted">The URL where this action applies (the page that will be loaded)</small>
                                        </div>

                                        <!-- Description -->
                                        <div class="mb-3">
                                            <label for="actionDescription" class="form-label fw-bold">
                                                <i class="bi bi-text-left me-1"></i>Description (Optional)
                                            </label>
                                            <textarea class="form-control" id="actionDescription" rows="2" 
                                                      placeholder="What does this action do?"></textarea>
                                        </div>

                                        <hr class="my-3">
                                        <h6 class="text-primary mb-3">
                                            <i class="bi bi-flag-fill me-2"></i>Trigger Configuration
                                        </h6>

                                        <!-- Action Trigger Tiles -->
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">
                                                <i class="bi bi-lightning-charge me-1"></i>Action Trigger Type
                                            </label>
                                            <div class="d-flex flex-wrap gap-2">
                                                <input type="radio" class="btn-check" name="triggerType" id="triggerNone" value="none">
                                                <label class="btn btn-outline-primary" for="triggerNone">
                                                    <i class="bi bi-x-circle me-1"></i>None
                                                </label>
                                                
                                                <input type="radio" class="btn-check" name="triggerType" id="triggerElement" value="element" checked>
                                                <label class="btn btn-outline-primary" for="triggerElement">
                                                    <i class="bi bi-square me-1"></i>Element Visible
                                                </label>
                                            </div>
                                            <small class="text-muted">Choose when this action should be triggered</small>
                                        </div>

                                        <!-- Element Configuration (shown when Element Visible is selected) -->
                                        <div id="elementTriggerConfig">
                                            <!-- Element Type -->
                                            <div class="mb-3">
                                                <label for="elementType" class="form-label fw-bold">
                                                    <i class="bi bi-box me-1"></i>Element Type
                                                </label>
                                                <select class="form-select" id="elementType">
                                                    <option value="div">Div Element</option>
                                                    <option value="button">Button Element</option>
                                                </select>
                                            </div>

                                            <!-- Element Selector -->
                                            <div class="mb-3">
                                                <label for="elementSelector" class="form-label fw-bold">
                                                    <i class="bi bi-code-square me-1"></i>CSS Selector
                                                </label>
                                                <input type="text" class="form-control" id="elementSelector" 
                                                       placeholder=".play-button, #videoPlayer">
                                                <small class="text-muted">CSS selector to identify the element</small>
                                            </div>

                                            <!-- Timeout -->
                                            <div class="mb-3">
                                                <label for="timeoutSeconds" class="form-label fw-bold">
                                                    <i class="bi bi-hourglass me-1"></i>Timeout
                                                </label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="timeoutSeconds" 
                                                           min="0" max="300" step="0.1" value="0">
                                                    <span class="input-group-text">seconds</span>
                                                </div>
                                                <small class="text-muted">0 = infinite wait (no timeout), &gt;0 = execute next action on timeout</small>
                                            </div>
                                        </div>

                                        <hr class="my-3">
                                        <h6 class="text-success mb-3">
                                            <i class="bi bi-lightning-fill me-2"></i>Action to Execute
                                        </h6>

                                        <!-- Quick Action Selection (shown when trigger type is "none") -->
                                        <div id="quickActionSelection" style="display: none;">
                                            <div class="mb-3">
                                                <label for="quickActionType" class="form-label fw-bold">
                                                    <i class="bi bi-lightning me-1"></i>Quick Action
                                                </label>
                                                <select class="form-select" id="quickActionType">
                                                    <option value="">Select a quick action...</option>
                                                    <option value="none">None (Just Navigate)</option>
                                                    <option value="fullscreen">Full screen</option>
                                                </select>
                                                <small class="text-muted">Choose a quick action to execute</small>
                                            </div>
                                        </div>

                                        <!-- Standard Action Type Selection (shown when trigger type is "element") -->
                                        <div id="standardActionSelection">
                                            <!-- Action Type -->
                                            <div class="mb-3">
                                                <label for="actionType" class="form-label fw-bold">
                                                    <i class="bi bi-cursor-fill me-1"></i>Action Type
                                                </label>
                                                <select class="form-select" id="actionType">
                                                    <option value="click">Simulate Mouse Click at Coordinates</option>
                                                    <option value="navigate">Navigate to Different URL</option>
                                                </select>
                                                <small class="text-muted">What should happen when the element is detected?</small>
                                            </div>

                                            <!-- Click Coordinates (conditional) -->
                                            <div class="mb-3" id="clickCoordinatesContainer">
                                                <label class="form-label fw-bold">
                                                    <i class="bi bi-cursor-fill me-1"></i>Click Coordinates
                                                </label>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label for="actionClickX" class="form-label">X:</label>
                                                        <input type="number" class="form-control" id="actionClickX" 
                                                               placeholder="100" min="0" value="100">
                                                    </div>
                                                    <div class="col-6">
                                                        <label for="actionClickY" class="form-label">Y:</label>
                                                        <input type="number" class="form-control" id="actionClickY" 
                                                               placeholder="100" min="0" value="100">
                                                    </div>
                                                </div>
                                                <small class="text-muted">Pixel coordinates where to click (top-left is 0,0)</small>
                                            </div>

                                            <!-- Navigate URL (conditional) -->
                                            <div class="mb-3" id="navigateUrlContainer" style="display: none;">
                                                <label for="navigateUrl" class="form-label fw-bold">
                                                    <i class="bi bi-link-45deg me-1"></i>Navigate To (Destination URL)
                                                </label>
                                                <input type="url" class="form-control" id="navigateUrl" 
                                                       placeholder="https://example.com/next-page">
                                                <small class="text-muted">The URL to navigate to when the element appears</small>
                                            </div>
                                        </div>

                                        <!-- Delay -->
                                        <div class="mb-3">
                                            <label for="delaySeconds" class="form-label fw-bold">
                                                <i class="bi bi-clock me-1"></i>Delay Before Execution
                                            </label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="delaySeconds" 
                                                       min="0" max="300" step="0.1" value="0">
                                                <span class="input-group-text">seconds</span>
                                            </div>
                                            <small class="text-muted">0 = immediate, supports decimals (e.g., 1.5)</small>
                                        </div>

                                        <!-- Active Status -->
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="isActive" checked>
                                                <label class="form-check-label" for="isActive">
                                                    <i class="bi bi-toggle-on me-1"></i>Action is Active
                                                </label>
                                            </div>
                                            <small class="text-muted">Only active actions will be executed on the client</small>
                                        </div>

                                        <!-- Submit Buttons -->
                                        <div class="d-flex gap-2 mb-3">
                                            <button type="button" class="btn btn-outline-secondary" id="btnPrevAction" disabled title="Edit previous action in chain">
                                                <i class="bi bi-arrow-left me-1"></i>Previous
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" id="btnNextAction" disabled title="Edit next action in chain">
                                                Next<i class="bi bi-arrow-right ms-1"></i>
                                            </button>
                                            <div class="flex-grow-1"></div>
                                            <button type="button" class="btn btn-outline-info" id="btnAddStep">
                                                <i class="bi bi-plus-circle me-1"></i>Add Step
                                            </button>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-primary" id="btnSaveAction">
                                                <i class="bi bi-check-circle me-2"></i>
                                                <span id="btnSaveText">Create Action</span>
                                            </button>
                                            <button type="button" class="btn btn-secondary" id="btnCancelEdit" style="display: none;">
                                                <i class="bi bi-x-circle me-2"></i>Cancel Edit
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- JSON Tab -->
                        <div class="tab-pane fade" id="json-tab-pane" role="tabpanel">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label for="actionJsonEditor" class="form-label fw-bold mb-0">
                                        <i class="bi bi-code-square me-1"></i>JSON Representation
                                    </label>
                                    <button type="button" class="btn btn-sm btn-outline-light" id="btnFormatJson" title="Format JSON">
                                        <i class="bi bi-chevron-expand"></i> Format
                                    </button>
                                </div>
                                <textarea class="form-control font-monospace" id="actionJsonEditor" rows="20" 
                                          style="font-size: 0.9rem; background-color: #1e1e1e; color: #d4d4d4; border-color: #444;"></textarea>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>Edit the JSON directly. Changes will sync with the form.
                                </small>
                                <div class="alert alert-danger mt-2 d-none" id="jsonErrorAlert">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    <span id="jsonErrorMessage"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Action Confirmation Modal -->
    <div class="modal fade" id="deleteActionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this action?</p>
                    <p class="mb-0"><strong id="deleteActionName"></strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmDeleteAction">
                        <i class="bi bi-trash me-1"></i>Delete Action
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="/server.js"></script>
</body>
</html>
