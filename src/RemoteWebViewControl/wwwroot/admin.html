<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Remote View Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .status-badge {
            padding: 0.35rem 0.65rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status-partial {
            background-color: #fff3cd;
            color: #856404;
        }
        .session-code {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .table th {
            background-color: #f8f9fa;
        }
        .btn-danger-custom {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border: none;
            color: white;
        }
        .btn-danger-custom:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            color: white;
        }
        .refresh-btn {
            animation: none;
        }
        .refresh-btn.spinning {
            animation: spin 1s linear;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .header-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px 15px 0 0;
        }
        .empty-state {
            padding: 3rem;
            text-align: center;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header-gradient">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-1"><i class="bi bi-shield-lock me-2"></i>Admin Panel</h2>
                        <p class="mb-0 opacity-75">Session Management & Monitoring</p>
                    </div>
                    <div>
                        <button id="btnRefresh" class="btn btn-light me-2" title="Refresh sessions">
                            <i class="bi bi-arrow-clockwise refresh-btn"></i>
                        </button>
                        <button id="btnClearAll" class="btn btn-danger-custom" title="Clear all sessions">
                            <i class="bi bi-trash me-1"></i>Clear All Sessions
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-0">Active Sessions</h5>
                        <small class="text-muted">Last updated: <span id="lastUpdate">Never</span></small>
                    </div>
                    <div>
                        <span class="badge bg-primary" id="sessionCount">0 Sessions</span>
                    </div>
                </div>

                <div id="sessionsContainer">
                    <!-- Sessions will be loaded here -->
                </div>
            </div>
        </div>

        <div class="text-center mt-3">
            <a href="/server.html" class="btn btn-outline-light">
                <i class="bi bi-arrow-left me-1"></i>Back to Server Control
            </a>
        </div>
    </div>

    <!-- Clear All Confirmation Modal -->
    <div class="modal fade" id="clearAllModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Clear All</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2"><strong>This action will:</strong></p>
                    <ul class="mb-3">
                        <li>Disconnect all server pages</li>
                        <li>Disconnect all client applications</li>
                        <li>Reset all sessions to initial state</li>
                        <li>Close any open displays on client apps</li>
                    </ul>
                    <p class="text-danger mb-0"><strong>This cannot be undone!</strong></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmClear">
                        <i class="bi bi-trash me-1"></i>Clear All Sessions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        let connection = null;
        let clearAllModal = null;

        async function loadSessions() {
            try {
                const response = await fetch('/api/admin/sessions');
                const sessions = await response.json();
                
                displaySessions(sessions);
                updateLastRefresh();
            } catch (error) {
                console.error('Error loading sessions:', error);
                showError('Failed to load sessions');
            }
        }

        function displaySessions(sessions) {
            const container = document.getElementById('sessionsContainer');
            const countBadge = document.getElementById('sessionCount');
            
            countBadge.textContent = `${sessions.length} Session${sessions.length !== 1 ? 's' : ''}`;

            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="mt-3 mb-0">No active sessions</p>
                        <small class="text-muted">Sessions will appear here when created</small>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Session Code</th>
                                <th>Created</th>
                                <th>Server Status</th>
                                <th>Client Status</th>
                                <th>Overall Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sessions.map(session => createSessionRow(session)).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        function createSessionRow(session) {
            const serverStatus = session.isServerConnected;
            const clientStatus = session.isClientConnected;
            
            let overallStatus, overallClass;
            if (serverStatus && clientStatus) {
                overallStatus = 'Fully Connected';
                overallClass = 'status-connected';
            } else if (serverStatus || clientStatus) {
                overallStatus = 'Partially Connected';
                overallClass = 'status-partial';
            } else {
                overallStatus = 'Disconnected';
                overallClass = 'status-disconnected';
            }

            const createdTime = new Date(session.createdAt).toLocaleString();
            const timeAgo = getTimeAgo(new Date(session.createdAt));

            return `
                <tr>
                    <td><span class="session-code">${session.code}</span></td>
                    <td>
                        <div>${createdTime}</div>
                        <small class="text-muted">${timeAgo}</small>
                    </td>
                    <td>
                        <i class="bi bi-circle-fill ${serverStatus ? 'text-success' : 'text-danger'}"></i>
                        ${serverStatus ? 'Connected' : 'Disconnected'}
                    </td>
                    <td>
                        <i class="bi bi-circle-fill ${clientStatus ? 'text-success' : 'text-danger'}"></i>
                        ${clientStatus ? 'Connected' : 'Disconnected'}
                    </td>
                    <td>
                        <span class="status-badge ${overallClass}">
                            ${overallStatus}
                        </span>
                    </td>
                </tr>
            `;
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function updateLastRefresh() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function showError(message) {
            const container = document.getElementById('sessionsContainer');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>${message}
                </div>
            `;
        }

        async function clearAllSessions() {
            try {
                // Use SignalR to clear sessions so signals are sent to clients
                if (connection && connection.state === signalR.HubConnectionState.Connected) {
                    console.log('Clearing all sessions via SignalR...');
                    await connection.invoke('ClearAllSessions');
                    console.log('Sessions cleared successfully');
                    
                    // Wait a moment for clients to disconnect
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Reload sessions
                    await loadSessions();
                    
                    // Show success message
                    const container = document.getElementById('sessionsContainer');
                    const successAlert = document.createElement('div');
                    successAlert.className = 'alert alert-success alert-dismissible fade show';
                    successAlert.innerHTML = `
                        <i class="bi bi-check-circle me-2"></i>All sessions cleared successfully!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    container.insertBefore(successAlert, container.firstChild);
                    
                    setTimeout(() => successAlert.remove(), 5000);
                } else {
                    throw new Error('Not connected to server');
                }
            } catch (error) {
                console.error('Error clearing sessions:', error);
                alert('Failed to clear sessions: ' + error.message);
            }
        }

        async function connectToHub() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl('/hub/remoteview')
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            try {
                await connection.start();
                console.log('SignalR connected');
            } catch (error) {
                console.error('SignalR connection error:', error);
            }
        }

        // Event listeners
        document.getElementById('btnRefresh').addEventListener('click', async () => {
            const icon = document.querySelector('.refresh-btn');
            icon.classList.add('spinning');
            await loadSessions();
            setTimeout(() => icon.classList.remove('spinning'), 1000);
        });

        document.getElementById('btnClearAll').addEventListener('click', () => {
            clearAllModal.show();
        });

        document.getElementById('btnConfirmClear').addEventListener('click', async () => {
            clearAllModal.hide();
            await clearAllSessions();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            clearAllModal = new bootstrap.Modal(document.getElementById('clearAllModal'));
            await connectToHub();
            await loadSessions();
            
            // Auto-refresh every 5 seconds
            setInterval(loadSessions, 5000);
        });
    </script>
</body>
</html>
